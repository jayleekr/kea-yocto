#!/bin/bash\n\n# ARM64 VM ì „ìš© Yocto í™˜ê²½ ì‹¤í–‰ ìŠ¤í¬ë¦½íŠ¸\n# exec format error ì™„ì „ í•´ê²°ì„ ìœ„í•œ ê°•ì œ ìˆ˜ì •\n\nset -e\n\n# ìƒ‰ìƒ ì •ì˜\nGREEN='\\033[0;32m'\nYELLOW='\\033[1;33m'\nBLUE='\\033[0;34m'\nRED='\\033[0;31m'\nNC='\\033[0m'\n\nlog_info() {\n    echo -e \"${GREEN}[INFO]${NC} $1\"\n}\n\nlog_step() {\n    echo -e \"${BLUE}[STEP]${NC} $1\"\n}\n\nlog_error() {\n    echo -e \"${RED}[ERROR]${NC} $1\"\n}\n\nlog_warning() {\n    echo -e \"${YELLOW}[WARNING]${NC} $1\"\n}\n\necho \"ğŸ”§ ARM64 VM exec format error ì™„ì „ í•´ê²°\"\necho \"========================================\"\necho\n\n# ì‹œìŠ¤í…œ í™•ì¸\nARCH=$(uname -m)\nlog_info \"ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜: $ARCH\"\n\nif [ \"$ARCH\" != \"aarch64\" ]; then\n    log_error \"ì´ ìŠ¤í¬ë¦½íŠ¸ëŠ” ARM64 VM (aarch64) ì „ìš©ì…ë‹ˆë‹¤.\"\n    echo \"í˜„ì¬ ì‹œìŠ¤í…œ: $ARCH\"\n    exit 1\nfi\n\n# Docker ì„œë¹„ìŠ¤ í™•ì¸\nlog_step \"Docker ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸...\"\nif ! systemctl is-active --quiet docker; then\n    log_warning \"Docker ì„œë¹„ìŠ¤ê°€ ì‹¤í–‰ë˜ì§€ ì•Šê³  ìˆìŠµë‹ˆë‹¤.\"\n    echo \"ë‹¤ìŒ ëª…ë ¹ìœ¼ë¡œ Dockerë¥¼ ì‹œì‘í•˜ì„¸ìš”:\"\n    echo \"sudo systemctl start docker\"\n    exit 1\nfi\n\n# ê¸°ì¡´ ì´ë¯¸ì§€ ì™„ì „ ì‚­ì œ\nDOCKER_IMAGE=\"jabang3/yocto-lecture:5.0-lts\"\nlog_step \"ê¸°ì¡´ ì´ë¯¸ì§€ ì™„ì „ ì‚­ì œ ì¤‘...\"\ndocker rmi -f $DOCKER_IMAGE 2>/dev/null || true\ndocker system prune -f 2>/dev/null || true\n\n# ì‹¤í–‰ ë°©ë²• ì„ íƒ\necho \"ARM64 VMì—ì„œ ì‹¤í–‰ ë°©ë²•ì„ ì„ íƒí•˜ì„¸ìš”:\"\necho \"1) ARM64 ë„¤ì´í‹°ë¸Œ (ê¶Œì¥)\"\necho \"2) x86_64 ì—ë®¬ë ˆì´ì…˜ (ê°•ì˜ í™˜ê²½ ì¼ì¹˜)\"\nread -p \"ì„ íƒ [1/2]: \" choice\n\nif [ \"$choice\" = \"2\" ]; then\n    # x86_64 ì—ë®¬ë ˆì´ì…˜ ëª¨ë“œ\n    log_info \"x86_64 ì—ë®¬ë ˆì´ì…˜ ëª¨ë“œë¥¼ ì„¤ì •í•©ë‹ˆë‹¤.\"\n    \n    # QEMU ì„¤ì¹˜ í™•ì¸\n    if ! dpkg -l | grep -q qemu-user-static; then\n        log_step \"QEMU ì„¤ì¹˜ ì¤‘...\"\n        sudo apt-get update\n        sudo apt-get install -y qemu-user-static binfmt-support\n    fi\n    \n    # QEMU ì—ë®¬ë ˆì´ì…˜ í™œì„±í™”\n    log_step \"QEMU ì—ë®¬ë ˆì´ì…˜ í™œì„±í™” ì¤‘...\"\n    docker run --rm --privileged multiarch/qemu-user-static --reset -p yes\n    \n    # x86_64 ì´ë¯¸ì§€ ê°•ì œ ë‹¤ìš´ë¡œë“œ\n    log_step \"x86_64 ì´ë¯¸ì§€ ê°•ì œ ë‹¤ìš´ë¡œë“œ ì¤‘...\"\n    docker pull --platform linux/amd64 $DOCKER_IMAGE\n    PLATFORM_FLAG=\"--platform linux/amd64\"\n    BB_THREADS=\"4\"\n    PARALLEL_MAKE=\"-j 4\"\n    \nelse\n    # ARM64 ë„¤ì´í‹°ë¸Œ ëª¨ë“œ\n    log_info \"ARM64 ë„¤ì´í‹°ë¸Œ ëª¨ë“œë¥¼ ì„¤ì •í•©ë‹ˆë‹¤.\"\n    \n    # ARM64 ì´ë¯¸ì§€ ê°•ì œ ë‹¤ìš´ë¡œë“œ\n    log_step \"ARM64 ì´ë¯¸ì§€ ê°•ì œ ë‹¤ìš´ë¡œë“œ ì¤‘...\"\n    docker pull --platform linux/arm64 $DOCKER_IMAGE\n    PLATFORM_FLAG=\"--platform linux/arm64\"\n    BB_THREADS=\"8\"\n    PARALLEL_MAKE=\"-j 8\"\nfi\n\n# ì´ë¯¸ì§€ ì•„í‚¤í…ì²˜ ê²€ì¦\nlog_step \"ë‹¤ìš´ë¡œë“œëœ ì´ë¯¸ì§€ ì•„í‚¤í…ì²˜ ê²€ì¦ ì¤‘...\"\nIMAGE_ARCH=$(docker image inspect $DOCKER_IMAGE | grep -o '\"Architecture\":\"[^\"]*\"' | cut -d'\"' -f4 | head -1)\nlog_info \"ì´ë¯¸ì§€ ì•„í‚¤í…ì²˜: $IMAGE_ARCH\"\n\n# ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ìƒì„±\nlog_step \"ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ìƒì„± ì¤‘...\"\nmkdir -p yocto-workspace/{workspace,downloads,sstate-cache}\n\n# ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì •ë¦¬\ndocker rm -f yocto-lecture 2>/dev/null || true\n\necho\nlog_step \"Yocto ì»¨í…Œì´ë„ˆ ì‹œì‘ ì¤‘...\"\necho \"í”Œë«í¼: $PLATFORM_FLAG\"\necho \"ì´ë¯¸ì§€: $DOCKER_IMAGE ($IMAGE_ARCH)\"\necho\n\ncd yocto-workspace\n\n# ì»¨í…Œì´ë„ˆ ì‹¤í–‰\ndocker run -it --rm \\\n    $PLATFORM_FLAG \\\n    --privileged \\\n    -v $(pwd)/workspace:/workspace \\\n    -v $(pwd)/downloads:/opt/yocto/downloads \\\n    -v $(pwd)/sstate-cache:/opt/yocto/sstate-cache \\\n    -e BB_NUMBER_THREADS=${BB_THREADS} \\\n    -e PARALLEL_MAKE=\"${PARALLEL_MAKE}\" \\\n    -e MACHINE=qemux86-64 \\\n    -e TMPDIR=/tmp/yocto-build \\\n    -e BB_ENV_PASSTHROUGH_ADDITIONS=TMPDIR \\\n    --name yocto-lecture \\\n    ${DOCKER_IMAGE} \\\n    /bin/bash -c \"\n        echo 'ğŸ‰ ARM64 VM Yocto í™˜ê²½ ì‹œì‘!'\n        echo 'VM ì•„í‚¤í…ì²˜: $ARCH'\n        echo 'ì»¨í…Œì´ë„ˆ ì•„í‚¤í…ì²˜: \\$(uname -m)'\n        echo 'ì´ë¯¸ì§€ ì•„í‚¤í…ì²˜: $IMAGE_ARCH'\n        echo\n        echo '=== Yocto í™˜ê²½ ì´ˆê¸°í™” ==='\n        source /opt/poky/oe-init-build-env /workspace/build\n        \n        echo\n        echo '=== ë¹Œë“œ ì„¤ì • í™•ì¸ ==='\n        echo 'BitBake ë²„ì „:'\n        bitbake --version\n        echo\n        echo 'MACHINE: qemux86-64'\n        echo 'BB_NUMBER_THREADS: ${BB_THREADS}'\n        echo 'PARALLEL_MAKE: ${PARALLEL_MAKE}'\n        echo\n        echo '=== ë¹Œë“œ ëª…ë ¹ì–´ ì˜ˆì‹œ ==='\n        echo '  bitbake core-image-minimal      # ìµœì†Œ ì´ë¯¸ì§€'\n        echo '  bitbake core-image-full-cmdline # ì „ì²´ ì´ë¯¸ì§€'\n        echo '  runqemu qemux86-64              # QEMU ì‹¤í–‰'\n        echo\n        echo 'ğŸš€ ARM64 VMì—ì„œ Yocto ë¹Œë“œ ì¤€ë¹„ ì™„ë£Œ!'\n        /bin/bash -l\n    \"\n\necho\nlog_info \"ARM64 VM Yocto í™˜ê²½ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.\"\nlog_info \"ì›Œí¬ìŠ¤í˜ì´ìŠ¤ëŠ” yocto-workspaceì— ë³´ì¡´ë©ë‹ˆë‹¤.\"" 