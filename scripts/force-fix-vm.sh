#!/bin/bash\n\n# VM exec format error ê°•ì œ í•´ê²° ìŠ¤í¬ë¦½íŠ¸\n# Docker ì´ë¯¸ì§€ ì™„ì „ ì¬ì„¤ì •\n\nset -e\n\necho \"ğŸ”§ VM exec format error ê°•ì œ í•´ê²°\"\necho \"==================================\"\necho\n\n# ì‹œìŠ¤í…œ í™•ì¸\nARCH=$(uname -m)\necho \"ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜: $ARCH\"\n\nDOCKER_IMAGE=\"jabang3/yocto-lecture:5.0-lts\"\n\necho\necho \"1ë‹¨ê³„: ëª¨ë“  ê´€ë ¨ ì´ë¯¸ì§€ ì™„ì „ ì‚­ì œ\"\necho \"==================================\"\n\n# ëª¨ë“  yocto ê´€ë ¨ ì´ë¯¸ì§€ ì‚­ì œ\ndocker images | grep yocto | awk '{print $3}' | xargs -r docker rmi -f\ndocker images | grep jabang3 | awk '{print $3}' | xargs -r docker rmi -f\n\n# Docker ì‹œìŠ¤í…œ ì™„ì „ ì •ë¦¬\ndocker system prune -af\ndocker volume prune -f\n\necho \"âœ… ì´ë¯¸ì§€ ì •ë¦¬ ì™„ë£Œ\"\n\necho\necho \"2ë‹¨ê³„: ì•„í‚¤í…ì²˜ë³„ ì´ë¯¸ì§€ ê°•ì œ ë‹¤ìš´ë¡œë“œ\"\necho \"========================================\"\n\nif [ \"$ARCH\" = \"aarch64\" ]; then\n    echo \"ARM64 VM ê°ì§€ - ì‹¤í–‰ ë°©ë²• ì„ íƒ:\"\n    echo \"1) ARM64 ë„¤ì´í‹°ë¸Œ (ê¶Œì¥)\"\n    echo \"2) x86_64 ì—ë®¬ë ˆì´ì…˜ (ê°•ì˜ í™˜ê²½ ì¼ì¹˜)\"\n    read -p \"ì„ íƒ [1/2]: \" choice\n    \n    if [ \"$choice\" = \"2\" ]; then\n        echo \"x86_64 ì—ë®¬ë ˆì´ì…˜ ëª¨ë“œ ì„¤ì •...\"\n        \n        # QEMU ì„¤ì¹˜\n        if ! dpkg -l | grep -q qemu-user-static; then\n            echo \"QEMU ì„¤ì¹˜ ì¤‘...\"\n            sudo apt-get update\n            sudo apt-get install -y qemu-user-static binfmt-support\n        fi\n        \n        # QEMU ì—ë®¬ë ˆì´ì…˜ í™œì„±í™”\n        echo \"QEMU ì—ë®¬ë ˆì´ì…˜ í™œì„±í™”...\"\n        docker run --rm --privileged multiarch/qemu-user-static --reset -p yes\n        \n        # x86_64 ì´ë¯¸ì§€ ê°•ì œ ë‹¤ìš´ë¡œë“œ (ë‹¤ì´ì œìŠ¤íŠ¸ ì‚¬ìš©)\n        echo \"x86_64 ì´ë¯¸ì§€ ë‹¤ì´ì œìŠ¤íŠ¸ë¡œ ê°•ì œ ë‹¤ìš´ë¡œë“œ...\"\n        docker pull jabang3/yocto-lecture@sha256:cf56f85fbfeddb20a1f9277b63ada51b884f1bc65b86b28ebeb3a8698ac6437f\n        docker tag jabang3/yocto-lecture@sha256:cf56f85fbfeddb20a1f9277b63ada51b884f1bc65b86b28ebeb3a8698ac6437f $DOCKER_IMAGE\n        \n        PLATFORM_FLAG=\"--platform linux/amd64\"\n        TEST_MODE=\"x86_64 ì—ë®¬ë ˆì´ì…˜\"\n        \n    else\n        echo \"ARM64 ë„¤ì´í‹°ë¸Œ ëª¨ë“œ ì„¤ì •...\"\n        \n        # ARM64 ì´ë¯¸ì§€ ê°•ì œ ë‹¤ìš´ë¡œë“œ (ë‹¤ì´ì œìŠ¤íŠ¸ ì‚¬ìš©)\n        echo \"ARM64 ì´ë¯¸ì§€ ë‹¤ì´ì œìŠ¤íŠ¸ë¡œ ê°•ì œ ë‹¤ìš´ë¡œë“œ...\"\n        docker pull jabang3/yocto-lecture@sha256:22ebbf27ef813ef38bdb681ff93c7c1d13c911bc9d68fb67460ca6f148a81939\n        docker tag jabang3/yocto-lecture@sha256:22ebbf27ef813ef38bdb681ff93c7c1d13c911bc9d68fb67460ca6f148a81939 $DOCKER_IMAGE\n        \n        PLATFORM_FLAG=\"--platform linux/arm64\"\n        TEST_MODE=\"ARM64 ë„¤ì´í‹°ë¸Œ\"\n    fi\n    \nelif [ \"$ARCH\" = \"x86_64\" ]; then\n    echo \"x86_64 ì‹œìŠ¤í…œ ê°ì§€\"\n    \n    # x86_64 ì´ë¯¸ì§€ ê°•ì œ ë‹¤ìš´ë¡œë“œ (ë‹¤ì´ì œìŠ¤íŠ¸ ì‚¬ìš©)\n    echo \"x86_64 ì´ë¯¸ì§€ ë‹¤ì´ì œìŠ¤íŠ¸ë¡œ ê°•ì œ ë‹¤ìš´ë¡œë“œ...\"\n    docker pull jabang3/yocto-lecture@sha256:cf56f85fbfeddb20a1f9277b63ada51b884f1bc65b86b28ebeb3a8698ac6437f\n    docker tag jabang3/yocto-lecture@sha256:cf56f85fbfeddb20a1f9277b63ada51b884f1bc65b86b28ebeb3a8698ac6437f $DOCKER_IMAGE\n    \n    PLATFORM_FLAG=\"--platform linux/amd64\"\n    TEST_MODE=\"x86_64 ë„¤ì´í‹°ë¸Œ\"\n    \nelse\n    echo \"ì§€ì›í•˜ì§€ ì•ŠëŠ” ì•„í‚¤í…ì²˜: $ARCH\"\n    exit 1\nfi\n\necho \"âœ… ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ\"\n\necho\necho \"3ë‹¨ê³„: ì´ë¯¸ì§€ ê²€ì¦\"\necho \"==================\"\n\n# ì´ë¯¸ì§€ ì•„í‚¤í…ì²˜ í™•ì¸\nIMAGE_ARCH=$(docker image inspect $DOCKER_IMAGE | grep -o '\"Architecture\":\"[^\"]*\"' | cut -d'\"' -f4 | head -1)\necho \"ë‹¤ìš´ë¡œë“œëœ ì´ë¯¸ì§€ ì•„í‚¤í…ì²˜: $IMAGE_ARCH\"\necho \"ì„¤ì •ëœ í…ŒìŠ¤íŠ¸ ëª¨ë“œ: $TEST_MODE\"\n\necho\necho \"4ë‹¨ê³„: ê°„ë‹¨ í…ŒìŠ¤íŠ¸ ì‹¤í–‰\"\necho \"=======================\"\n\n# ê°„ë‹¨í•œ í…ŒìŠ¤íŠ¸ ì‹¤í–‰\necho \"ì»¨í…Œì´ë„ˆ ê¸°ë³¸ í…ŒìŠ¤íŠ¸ ì¤‘...\"\n\nmkdir -p test-workspace\n\ndocker run --rm \\\n    $PLATFORM_FLAG \\\n    -v $(pwd)/test-workspace:/workspace \\\n    --name yocto-quick-test \\\n    $DOCKER_IMAGE \\\n    /bin/bash -c \"\n        echo '=== ê¸°ë³¸ í…ŒìŠ¤íŠ¸ ==='\n        echo 'VM ì•„í‚¤í…ì²˜: $ARCH'\n        echo 'ì»¨í…Œì´ë„ˆ ì•„í‚¤í…ì²˜: \\$(uname -m)'\n        echo 'ì´ë¯¸ì§€ ì•„í‚¤í…ì²˜: $IMAGE_ARCH'\n        echo 'í…ŒìŠ¤íŠ¸ ëª¨ë“œ: $TEST_MODE'\n        echo ''\n        echo '=== í™˜ê²½ í™•ì¸ ==='\n        ls -la /opt/poky/\n        echo ''\n        echo 'âœ… ê¸°ë³¸ í…ŒìŠ¤íŠ¸ ì„±ê³µ!'\n    \" && {\n    echo\n    echo \"ğŸ‰ VM exec format error í•´ê²° ì™„ë£Œ!\"\n    echo \"=====================================\"\n    echo \"âœ… ì»¨í…Œì´ë„ˆê°€ ì •ìƒì ìœ¼ë¡œ ì‹¤í–‰ë©ë‹ˆë‹¤\"\n    echo \"âœ… $TEST_MODE ëª¨ë“œë¡œ ì„¤ì •ë¨\"\n    echo \"âœ… ì´ë¯¸ì§€ ì•„í‚¤í…ì²˜: $IMAGE_ARCH\"\n    echo\n    echo \"ë‹¤ìŒ ëª…ë ¹ìœ¼ë¡œ Yocto í™˜ê²½ì„ ì‹œì‘í•˜ì„¸ìš”:\"\n    echo \"  ./scripts/arm64-vm-fix.sh\"\n    echo \"  ë˜ëŠ”\"\n    echo \"  docker run -it --rm $PLATFORM_FLAG -v \\$(pwd)/yocto-workspace:/workspace $DOCKER_IMAGE\"\n    \n} || {\n    echo\n    echo \"âŒ ì—¬ì „íˆ ë¬¸ì œê°€ ìˆìŠµë‹ˆë‹¤\"\n    echo \"==========================\"\n    echo \"ë‹¤ìŒì„ í™•ì¸í•´ë³´ì„¸ìš”:\"\n    echo \"1. Docker ë²„ì „: docker --version\"\n    echo \"2. ê¶Œí•œ í™•ì¸: groups | grep docker\"\n    echo \"3. ì¬ë¶€íŒ… í›„ ë‹¤ì‹œ ì‹œë„\"\n    echo \"4. Docker ì¬ì„¤ì¹˜\"\n}\n\necho\necho \"ê°•ì œ ìˆ˜ì • ì‘ì—…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.\"" 