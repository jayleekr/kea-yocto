#!/bin/bash

# ê°„ë‹¨í•œ GitHub ìºì‹œ ì—…ë¡œë“œ ìŠ¤í¬ë¦½íŠ¸
set -euo pipefail

echo "ğŸš€ KEA Yocto ìºì‹œ GitHub ì—…ë¡œë“œ í…ŒìŠ¤íŠ¸"
echo "======================================"

# í† í° ì„¤ì •
export GITHUB_TOKEN=$(cat ~/token)
echo "âœ… í† í° ë¡œë“œ ì™„ë£Œ"

# ì‘ì—… ë””ë ‰í† ë¦¬ë¡œ ì´ë™
cd yocto-workspace

# ë¦´ë¦¬ìŠ¤ íƒœê·¸ ìƒì„±
RELEASE_TAG="cache-$(date +%Y%m%d-%H%M%S)"
RELEASE_TITLE="KEA Yocto Cache $(date '+%Y-%m-%d %H:%M')"

echo "ğŸ“¦ ë¦´ë¦¬ìŠ¤ ì •ë³´:"
echo "  íƒœê·¸: $RELEASE_TAG"
echo "  ì œëª©: $RELEASE_TITLE"

# íŒŒì¼ í™•ì¸
echo ""
echo "ğŸ“‚ ì—…ë¡œë“œí•  íŒŒì¼ë“¤:"
ls -la downloads-cache.tar.gz sstate-cache.tar.gz

# ì²´í¬ì„¬ ìƒì„±
echo ""
echo "ğŸ” ì²´í¬ì„¬ ìƒì„± ì¤‘..."
md5sum downloads-cache.tar.gz > downloads-cache.tar.gz.md5
md5sum sstate-cache.tar.gz > sstate-cache.tar.gz.md5
sha256sum downloads-cache.tar.gz > downloads-cache.tar.gz.sha256
sha256sum sstate-cache.tar.gz > sstate-cache.tar.gz.sha256

# ë¦´ë¦¬ìŠ¤ ë…¸íŠ¸ ìƒì„±
cat > release-notes.md << EOF
# KEA Yocto Project 5.0 LTS ìºì‹œ

**ìƒì„± ë‚ ì§œ:** $(date '+%Yë…„ %mì›” %dì¼ %H:%M:%S')
**Yocto ë²„ì „:** 5.0 LTS (Scarthgap)
**Docker ì´ë¯¸ì§€:** jabang3/yocto-lecture:5.0-lts

## ğŸ“¦ ìºì‹œ êµ¬ì„±

- **downloads-cache.tar.gz** ($(du -h downloads-cache.tar.gz | cut -f1)) - ì†ŒìŠ¤ ë‹¤ìš´ë¡œë“œ ìºì‹œ
- **sstate-cache.tar.gz** ($(du -h sstate-cache.tar.gz | cut -f1)) - ë¹Œë“œ ìƒíƒœ ìºì‹œ

## ğŸš€ ì‚¬ìš©ë²•

### 1. ìºì‹œ ë‹¤ìš´ë¡œë“œ
\`\`\`bash
mkdir yocto-workspace && cd yocto-workspace
wget https://github.com/jayleekr/kea-yocto/releases/download/$RELEASE_TAG/downloads-cache.tar.gz
wget https://github.com/jayleekr/kea-yocto/releases/download/$RELEASE_TAG/sstate-cache.tar.gz
\`\`\`

### 2. ìºì‹œ ì••ì¶• í•´ì œ
\`\`\`bash
tar -xzf downloads-cache.tar.gz
tar -xzf sstate-cache.tar.gz
\`\`\`

### 3. Docker ë¹Œë“œ ì‹¤í–‰
\`\`\`bash
docker run --rm -v "\$PWD:/shared" jabang3/yocto-lecture:5.0-lts /bin/bash -c "
  cd /home/yocto
  source /opt/poky/oe-init-build-env build
  echo 'DL_DIR = \"/shared/downloads\"' >> conf/local.conf
  echo 'SSTATE_DIR = \"/shared/sstate-cache\"' >> conf/local.conf
  bitbake core-image-minimal
"
\`\`\`

## âš¡ ì„±ëŠ¥ í–¥ìƒ

- ğŸš€ **98.4% íƒœìŠ¤í¬ ì¬ì‚¬ìš©ë¥ **
- â±ï¸ **ë¹Œë“œ ì‹œê°„ 50% ì´ìƒ ë‹¨ì¶•**
- ğŸ“¥ **ë„¤íŠ¸ì›Œí¬ ë‹¤ìš´ë¡œë“œ ìµœì†Œí™”**

## ğŸ” íŒŒì¼ ë¬´ê²°ì„± ê²€ì¦

MD5 ë° SHA256 ì²´í¬ì„¬ íŒŒì¼ì´ í•¨ê»˜ ì œê³µë©ë‹ˆë‹¤.

---
*Generated by KEA Yocto Cache Distribution System*
EOF

echo "âœ… ë¦´ë¦¬ìŠ¤ ë…¸íŠ¸ ìƒì„± ì™„ë£Œ"

# GitHub Release ìƒì„±
echo ""
echo "ğŸš€ GitHub Release ìƒì„± ì¤‘..."
gh release create "$RELEASE_TAG" \
    --title "$RELEASE_TITLE" \
    --notes-file release-notes.md \
    downloads-cache.tar.gz \
    downloads-cache.tar.gz.md5 \
    downloads-cache.tar.gz.sha256 \
    sstate-cache.tar.gz \
    sstate-cache.tar.gz.md5 \
    sstate-cache.tar.gz.sha256

echo ""
echo "ğŸ‰ ì—…ë¡œë“œ ì™„ë£Œ!"
echo "ğŸ“‚ ë¦´ë¦¬ìŠ¤ URL: https://github.com/jayleekr/kea-yocto/releases/tag/$RELEASE_TAG"
echo ""
echo "ğŸ“¥ ì§ì ‘ ë‹¤ìš´ë¡œë“œ URL:"
echo "  downloads-cache.tar.gz:"
echo "    https://github.com/jayleekr/kea-yocto/releases/download/$RELEASE_TAG/downloads-cache.tar.gz"
echo "  sstate-cache.tar.gz:"
echo "    https://github.com/jayleekr/kea-yocto/releases/download/$RELEASE_TAG/sstate-cache.tar.gz" 