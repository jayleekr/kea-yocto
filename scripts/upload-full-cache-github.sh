#!/bin/bash

# KEA Yocto ì „ì²´ ìºì‹œ GitHub ì—…ë¡œë“œ ìŠ¤í¬ë¦½íŠ¸
set -euo pipefail

echo "ğŸš€ KEA Yocto ì „ì²´ ìºì‹œ GitHub ì—…ë¡œë“œ"
echo "===================================="

# í† í° í™•ì¸
if [ ! -f ~/token ]; then
    echo "âŒ GitHub í† í°ì´ í•„ìš”í•©ë‹ˆë‹¤. ~/token íŒŒì¼ì— í† í°ì„ ì €ì¥í•´ì£¼ì„¸ìš”."
    exit 1
fi

export GITHUB_TOKEN=$(cat ~/token)
echo "âœ… í† í° ë¡œë“œ ì™„ë£Œ"

# ì „ì²´ ìºì‹œ ë””ë ‰í† ë¦¬ë¡œ ì´ë™
cd yocto-workspace-full

# íŒŒì¼ ì¡´ì¬ í™•ì¸
if [ ! -f "full-downloads-cache.tar.gz" ] || [ ! -f "full-sstate-cache.tar.gz" ]; then
    echo "âŒ ìºì‹œ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤. build-full-image-cache.shë¥¼ ë¨¼ì € ì‹¤í–‰í•´ì£¼ì„¸ìš”."
    exit 1
fi

# ë¦´ë¦¬ìŠ¤ íƒœê·¸ ìƒì„±
RELEASE_TAG="full-cache-$(date +%Y%m%d-%H%M%S)"
RELEASE_TITLE="KEA Yocto Full Cache $(date '+%Y-%m-%d %H:%M')"

echo "ğŸ“¦ ë¦´ë¦¬ìŠ¤ ì •ë³´:"
echo "  íƒœê·¸: $RELEASE_TAG"
echo "  ì œëª©: $RELEASE_TITLE"

# íŒŒì¼ í™•ì¸
echo ""
echo "ğŸ“‚ ì—…ë¡œë“œí•  íŒŒì¼ë“¤:"
ls -la full-*.tar.gz full-*.md5 full-*.sha256 full-*.txt

# ë¦´ë¦¬ìŠ¤ ë…¸íŠ¸ ìƒì„±
cat > release-notes.md << EOF
# KEA Yocto Project 5.0 LTS ì „ì²´ ì´ë¯¸ì§€ ìºì‹œ

**ìƒì„± ë‚ ì§œ:** $(date '+%Yë…„ %mì›” %dì¼ %H:%M:%S')
**ë¹Œë“œ ëŒ€ìƒ:** core-image-minimal
**Yocto ë²„ì „:** 5.0 LTS (Scarthgap)
**Docker ì´ë¯¸ì§€:** jabang3/yocto-lecture:5.0-lts

## ğŸ“¦ ìºì‹œ êµ¬ì„±

- **full-downloads-cache.tar.gz** ($(du -h full-downloads-cache.tar.gz | cut -f1)) - ì „ì²´ ì†ŒìŠ¤ ë‹¤ìš´ë¡œë“œ ìºì‹œ (88ê°œ íŒ¨í‚¤ì§€)
- **full-sstate-cache.tar.gz** ($(du -h full-sstate-cache.tar.gz | cut -f1)) - ì „ì²´ ë¹Œë“œ ìƒíƒœ ìºì‹œ (257ê°œ í•­ëª©)
- **full-cache-info.txt** - ìºì‹œ ì •ë³´ ë° ì‚¬ìš©ë²•

## ğŸš€ ì‚¬ìš©ë²•

### 1. ìºì‹œ ë‹¤ìš´ë¡œë“œ
\`\`\`bash
mkdir yocto-workspace && cd yocto-workspace
wget https://github.com/jayleekr/kea-yocto/releases/download/$RELEASE_TAG/full-downloads-cache.tar.gz
wget https://github.com/jayleekr/kea-yocto/releases/download/$RELEASE_TAG/full-sstate-cache.tar.gz
wget https://github.com/jayleekr/kea-yocto/releases/download/$RELEASE_TAG/full-cache-info.txt
\`\`\`

### 2. ìºì‹œ ì••ì¶• í•´ì œ ë° ê¶Œí•œ ì„¤ì •
\`\`\`bash
tar -xzf full-downloads-cache.tar.gz
tar -xzf full-sstate-cache.tar.gz
chmod -R 777 downloads sstate-cache
\`\`\`

### 3. Docker ë¹Œë“œ ì‹¤í–‰
\`\`\`bash
docker run --rm -v "\$PWD:/workspace" jabang3/yocto-lecture:5.0-lts bash -c "
  cd /workspace
  source /opt/poky/oe-init-build-env build
  echo 'DL_DIR = \"/workspace/downloads\"' >> build/conf/local.conf
  echo 'SSTATE_DIR = \"/workspace/sstate-cache\"' >> build/conf/local.conf
  bitbake core-image-minimal
"
\`\`\`

## âš¡ ì„±ëŠ¥ í–¥ìƒ

- ğŸš€ **80-90% ë¹Œë“œ ì‹œê°„ ë‹¨ì¶•**
- ğŸ“¥ **ë„¤íŠ¸ì›Œí¬ ë‹¤ìš´ë¡œë“œ ìµœì†Œí™”**
- ğŸ’¾ **6.7GB ìºì‹œ ë°ì´í„°ë¡œ ì™„ì „í•œ ë¹Œë“œ í™˜ê²½**
- âœ… **ê²€ì¦ëœ ì¬ì‚¬ìš© ê°€ëŠ¥í•œ ìºì‹œ**

## ğŸ” íŒŒì¼ ë¬´ê²°ì„± ê²€ì¦

MD5 ë° SHA256 ì²´í¬ì„¬ íŒŒì¼ì´ í•¨ê»˜ ì œê³µë©ë‹ˆë‹¤:

\`\`\`bash
md5sum -c full-downloads-cache.tar.gz.md5
md5sum -c full-sstate-cache.tar.gz.md5
sha256sum -c full-downloads-cache.tar.gz.sha256
sha256sum -c full-sstate-cache.tar.gz.sha256
\`\`\`

---
*Generated by KEA Yocto Full Cache Distribution System*
EOF

echo "âœ… ë¦´ë¦¬ìŠ¤ ë…¸íŠ¸ ìƒì„± ì™„ë£Œ"

# GitHub CLI ì„¤ì¹˜ í™•ì¸
if ! command -v gh &> /dev/null; then
    echo "âŒ GitHub CLI (gh)ê°€ í•„ìš”í•©ë‹ˆë‹¤. ì„¤ì¹˜í•´ì£¼ì„¸ìš”: sudo apt install gh"
    exit 1
fi

# GitHub Release ìƒì„±
echo ""
echo "ğŸš€ GitHub Release ìƒì„± ì¤‘..."
echo "âš ï¸  íŒŒì¼ì´ í¬ë¯€ë¡œ ì—…ë¡œë“œì— ì‹œê°„ì´ ê±¸ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤..."

cd /home/jayleekr/kea-yocto

gh release create "$RELEASE_TAG" \
    --title "$RELEASE_TITLE" \
    --notes-file yocto-workspace-full/release-notes.md \
    yocto-workspace-full/full-downloads-cache.tar.gz \
    yocto-workspace-full/full-downloads-cache.tar.gz.md5 \
    yocto-workspace-full/full-downloads-cache.tar.gz.sha256 \
    yocto-workspace-full/full-sstate-cache.tar.gz \
    yocto-workspace-full/full-sstate-cache.tar.gz.md5 \
    yocto-workspace-full/full-sstate-cache.tar.gz.sha256 \
    yocto-workspace-full/full-cache-info.txt

echo ""
echo "ğŸ‰ ì—…ë¡œë“œ ì™„ë£Œ!"
echo "ğŸ“‚ ë¦´ë¦¬ìŠ¤ URL: https://github.com/jayleekr/kea-yocto/releases/tag/$RELEASE_TAG"
echo ""
echo "ğŸ“¥ ì§ì ‘ ë‹¤ìš´ë¡œë“œ URL:"
echo "  full-downloads-cache.tar.gz:"
echo "    https://github.com/jayleekr/kea-yocto/releases/download/$RELEASE_TAG/full-downloads-cache.tar.gz"
echo "  full-sstate-cache.tar.gz:"
echo "    https://github.com/jayleekr/kea-yocto/releases/download/$RELEASE_TAG/full-sstate-cache.tar.gz"
echo "  full-cache-info.txt:"
echo "    https://github.com/jayleekr/kea-yocto/releases/download/$RELEASE_TAG/full-cache-info.txt"

echo ""
echo "ğŸ§ª í…ŒìŠ¤íŠ¸ ëª…ë ¹ì–´:"
echo "mkdir test-download && cd test-download"
echo "wget https://github.com/jayleekr/kea-yocto/releases/download/$RELEASE_TAG/full-downloads-cache.tar.gz"
echo "wget https://github.com/jayleekr/kea-yocto/releases/download/$RELEASE_TAG/full-sstate-cache.tar.gz" 