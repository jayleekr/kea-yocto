name: Build and Push Docker Image

on:
  push:
    branches: [ main, master ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main, master ]

env:
  # ë³´ì•ˆ ì˜µì…˜ 1: GitHub Container Registry (ê¶Œì¥)
  GHCR_REGISTRY: ghcr.io
  # ë³´ì•ˆ ì˜µì…˜ 2: Docker Hub (ê¸°ì¡´)
  DOCKERHUB_REGISTRY: docker.io
  IMAGE_NAME: yocto-lecture

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write  # GitHub Container Registryìš©
      id-token: write  # OIDCìš©

    steps:
    - name: ğŸ“‹ Checkout repository
      uses: actions/checkout@v4

    - name: ğŸ” Environment Debug Info
      run: |
        echo "=== ğŸ³ Docker Environment ==="
        docker --version
        docker info
        echo ""
        echo "=== ğŸ“¦ Build Context ==="
        echo "Event: ${{ github.event_name }}"
        echo "Ref: ${{ github.ref }}"
        echo "SHA: ${{ github.sha }}"
        echo "Actor: ${{ github.actor }}"
        echo ""
        echo "=== ğŸ” Registry Info ==="
        echo "GHCR Registry: ${{ env.GHCR_REGISTRY }}"
        echo "Docker Hub Registry: ${{ env.DOCKERHUB_REGISTRY }}"
        echo "Image Name: ${{ env.IMAGE_NAME }}"

    - name: ğŸ”§ Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: ğŸ” Log in to GitHub Container Registry (ë³´ì•ˆ ê¶Œì¥)
      if: github.event_name != 'pull_request'
      uses: docker/login-action@v3
      with:
        registry: ${{ env.GHCR_REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}  # ìë™ ìƒì„±, ë³„ë„ ì„¤ì • ë¶ˆí•„ìš”

    - name: ğŸ”‘ Log in to Docker Hub (ì„ íƒì‚¬í•­)
      if: github.event_name != 'pull_request' && secrets.DOCKERHUB_TOKEN != ''
      id: docker-login
      uses: docker/login-action@v3
      with:
        registry: ${{ env.DOCKERHUB_REGISTRY }}
        username: jabang3
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    - name: âœ… Verify Docker Login
      if: github.event_name != 'pull_request'
      run: |
        echo "=== ğŸ” Docker Login Verification ==="
        docker info | grep -i "username\|registry" || echo "Login info not available"
        echo "âœ… Registry login completed"

    - name: ğŸ·ï¸ Extract metadata for GHCR
      id: meta-ghcr
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.GHCR_REGISTRY }}/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}
        tags: |
          type=ref,event=branch
          type=ref,event=pr
          type=semver,pattern={{version}}
          type=semver,pattern={{major}}.{{minor}}
          type=raw,value=5.0-lts
          type=raw,value=latest,enable={{is_default_branch}}

    - name: ğŸ·ï¸ Extract metadata for Docker Hub
      id: meta-dockerhub
      if: secrets.DOCKERHUB_TOKEN != ''
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.DOCKERHUB_REGISTRY }}/jabang3/${{ env.IMAGE_NAME }}
        tags: |
          type=ref,event=branch
          type=ref,event=pr
          type=semver,pattern={{version}}
          type=semver,pattern={{major}}.{{minor}}
          type=raw,value=5.0-lts
          type=raw,value=latest,enable={{is_default_branch}}

    - name: ğŸ“‹ Display Build Info
      run: |
        echo "=== ğŸ—ï¸ Build Information ==="
        echo "GHCR Tags:"
        echo "${{ steps.meta-ghcr.outputs.tags }}"
        echo ""
        if [ "${{ secrets.DOCKERHUB_TOKEN }}" != "" ]; then
          echo "Docker Hub Tags:"
          echo "${{ steps.meta-dockerhub.outputs.tags }}"
        else
          echo "Docker Hub: í† í° ì—†ìŒ - GHCRë§Œ ì‚¬ìš©"
        fi
        echo ""
        echo "Will push: ${{ github.event_name != 'pull_request' }}"

    - name: ğŸ—ï¸ Build and push to GHCR (ë³´ì•ˆ ê¶Œì¥)
      id: build-ghcr
      uses: docker/build-push-action@v5
      with:
        context: .
        platforms: linux/amd64,linux/arm64
        push: ${{ github.event_name != 'pull_request' }}
        tags: ${{ steps.meta-ghcr.outputs.tags }}
        labels: ${{ steps.meta-ghcr.outputs.labels }}
        build-args: |
          UBUNTU_VERSION=24.04
          TARGETPLATFORM=linux/amd64
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: ğŸ—ï¸ Build and push to Docker Hub (ì„ íƒì‚¬í•­)
      id: build-dockerhub
      if: github.event_name != 'pull_request' && secrets.DOCKERHUB_TOKEN != ''
      uses: docker/build-push-action@v5
      with:
        context: .
        platforms: linux/amd64,linux/arm64
        push: true
        tags: ${{ steps.meta-dockerhub.outputs.tags }}
        labels: ${{ steps.meta-dockerhub.outputs.labels }}
        build-args: |
          UBUNTU_VERSION=24.04
          TARGETPLATFORM=linux/amd64
        cache-from: type=gha

    - name: ğŸ“Š Build Summary
      run: |
        echo "=== ğŸ“Š Build Results ==="
        echo "GHCR Image ID: ${{ steps.build-ghcr.outputs.imageid }}"
        echo "GHCR Image Digest: ${{ steps.build-ghcr.outputs.digest }}"
        if [ "${{ secrets.DOCKERHUB_TOKEN }}" != "" ]; then
          echo "Docker Hub Image ID: ${{ steps.build-dockerhub.outputs.imageid }}"
          echo "Docker Hub Image Digest: ${{ steps.build-dockerhub.outputs.digest }}"
        fi

    - name: ğŸ§ª Test Docker image
      if: github.event_name != 'pull_request'
      run: |
        echo "=== ğŸ§ª Testing Docker Image ==="
        
        # GHCR ì´ë¯¸ì§€ í…ŒìŠ¤íŠ¸
        GHCR_IMAGE="${{ env.GHCR_REGISTRY }}/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}:latest"
        echo "ğŸ” Testing GHCR image: $GHCR_IMAGE"
        
        docker run --rm $GHCR_IMAGE cat /etc/os-release
        docker run --rm $GHCR_IMAGE bash -c "
          source /opt/poky/oe-init-build-env /tmp/test && 
          bitbake --version
        "
        
        echo "âœ… Docker image test completed successfully!"

    - name: ğŸ“ˆ Post-build Status
      if: always()
      run: |
        echo "=== ğŸ“ˆ Final Status ==="
        echo "Job Status: ${{ job.status }}"
        echo "Steps Status:"
        echo "- GHCR Build: ${{ steps.build-ghcr.conclusion || 'skipped' }}"
        echo "- Docker Hub Build: ${{ steps.build-dockerhub.conclusion || 'skipped' }}"
        echo ""
        if [ "${{ job.status }}" = "success" ]; then
          echo "ğŸ‰ Build completed successfully!"
          echo "GHCR Image: ${{ env.GHCR_REGISTRY }}/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}:5.0-lts"
          if [ "${{ secrets.DOCKERHUB_TOKEN }}" != "" ]; then
            echo "Docker Hub Image: ${{ env.DOCKERHUB_REGISTRY }}/jabang3/${{ env.IMAGE_NAME }}:5.0-lts"
          fi
        else
          echo "âŒ Build failed. Check the logs above for details."
        fi

    - name: ğŸš¨ Failure Notification
      if: failure()
      run: |
        echo "=== ğŸš¨ Build Failure Debug ==="
        echo "Failed step: ${{ github.action }}"
        echo "Repository: ${{ github.repository }}"
        echo "Workflow: ${{ github.workflow }}"
        echo "Run ID: ${{ github.run_id }}"
        echo "Run URL: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        echo ""
        echo "ğŸ’¡ Common fixes:"
        echo "1. GHCR ì‚¬ìš©ì‹œ ë³„ë„ í† í° ì„¤ì • ë¶ˆí•„ìš” (GITHUB_TOKEN ìë™ ì‚¬ìš©)"
        echo "2. Docker Hub ì‚¬ìš©ì‹œ DOCKERHUB_TOKEN secret í™•ì¸"
        echo "3. Repository settings > Actions > General > Workflow permissions í™•ì¸" 